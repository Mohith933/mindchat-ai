<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MindChat AI â€” Memory Companion (Step 4)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb; --text:#111827; --accent:#7b5cff; --muted:#eef0fb;
}
@media(prefers-color-scheme:dark){
  :root{ --bg:#0c0c10; --text:#eef2ff; --accent:#a58dff; --muted:#121217; }
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; padding:0;}
body{display:flex; min-height:100vh; background:var(--bg); color:var(--text); overflow:hidden;}
.sidebar{width:260px;background:var(--muted); padding:20px; display:flex; flex-direction:column; gap:12px;}
.sidebar h2{color:var(--accent); font-size:1.1rem;}
.sessions{flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px;}
.session-item{padding:10px; border-radius:8px; cursor:pointer; background:transparent; border:1px solid rgba(0,0,0,0.03);}
.session-item.active{background:linear-gradient(90deg,var(--accent),#b993ff); color:#fff;}
.controls{display:flex; gap:8px;}
.btn{background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
.btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06); font-weight:600;}
.small{padding:6px 8px; font-size:0.9rem;}
.main{flex:1; display:flex; flex-direction:column; border-left:1px solid rgba(0,0,0,0.04); border-right:1px solid rgba(0,0,0,0.04);}
.header{display:flex; justify-content:space-between; align-items:center; padding:18px 22px; background:transparent;}
.header h1{color:var(--accent); font-size:1.2rem;}
.container{display:flex; flex:1; gap:12px; padding:16px;}
.chat-area{flex:1; display:flex; flex-direction:column; background:transparent; min-height:0;}
.chat-window{flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:10px;}
.message{max-width:72%; padding:10px 14px; border-radius:12px; line-height:1.45; font-size:15px; box-shadow:0 6px 18px rgba(0,0,0,0.04);}
.message.user{align-self:flex-end; background:var(--accent); color:#fff;}
.message.ai{align-self:flex-start; background:#000; border:1px solid rgba(0,0,0,0.06);}
.meta{font-size:11px; opacity:0.7; margin-top:6px;}
.input-area{display:flex; gap:10px; padding:12px; background:transparent; align-items:center; border-top:1px solid rgba(0,0,0,0.03);}
.input-area input{flex:1; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); outline:none;}
.input-area button{padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:#fff; font-weight:700;}
.side-graph{width:340px; padding:18px; background:var(--muted); border-radius:10px; display:flex; flex-direction:column; gap:12px; min-width:240px;}
.graph-canvas{background:#fff; border-radius:10px; width:100%; height:360px; display:block; border:1px solid rgba(0,0,0,0.04);}
.tooltip{position:absolute;background:#111;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;pointer-events:none;opacity:0;transition:opacity .12s;}
.controls-row{display:flex; gap:8px; align-items:center;}
.clear-btn{background:#fff; color:var(--accent); border:1px solid var(--accent); padding:8px 10px; border-radius:8px; cursor:pointer;}
.clear-btn:hover{background:var(--accent); color:#fff;}
@media(max-width:1000px){
  .side-graph{display:none;}
  .sidebar{width:200px;}
  .session-item{font-size:0.95rem;}
}
.small-muted{font-size:12px; opacity:0.7;}
</style>
</head>
<body>

<!-- SIDEBAR: sessions & quick actions -->
<div class="sidebar" aria-label="Sessions and memory controls">
  <h2>ðŸ§  Sessions</h2>
  <div class="controls">
    <button id="newSessionBtn" class="btn small">ï¼‹ New</button>
    <button id="saveSessionBtn" class="btn small">Save</button>
  </div>

  <div class="sessions" id="sessionsList" aria-live="polite">
    <!-- session items injected -->
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <button id="exportBtn" class="btn small">Export Chat</button>
    <button id="clearMemoryBtn" class="clear-btn small">ðŸ§¹ Clear Memory</button>
  </div>
  <div class="small-muted">Memory nodes & links persist locally. Clear will remove them.</div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="header">
    <h1>MindChat AI â€” Memory Companion</h1>
    <div class="controls-row">
      <div id="typingIndicator" class="small-muted" style="min-width:120px"></div>
      <button id="downloadGraphBtn" class="btn ghost small">Save Graph JSON</button>
    </div>
  </div>

  <div class="container">
    <!-- Chat -->
    <div class="chat-area" role="main">
      <div id="chatWindow" class="chat-window" aria-live="polite">
        <!-- messages -->
      </div>

      <div class="input-area">
        <input id="userInput" placeholder="Type your thought... (Ctrl+Enter to send)" aria-label="Type your thought">
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <!-- Graph area -->
    <div class="side-graph" aria-label="Memory graph">
      <h3 style="margin:0;color:var(--accent)">ðŸ•¸ Memory Graph</h3>
      <canvas id="graphCanvas" class="graph-canvas" width="640" height="480"></canvas>
      <div style="display:flex; gap:8px;">
        <button id="clearGraphBtn" class="clear-btn small">ðŸ§¹ Clear Memory</button>
        <button id="saveNodesBtn" class="btn small ghost">Save Nodes</button>
      </div>
      <div id="tooltip" class="tooltip" aria-hidden="true"></div>
    </div>
  </div>
</div>

<script>
/* ----------------------------------------
   MindChat Step 5 â€” Dynamic Emotion Graph
   Adds:
    - Emotion pulse (glow)
    - Line animation on new connection
    - Node fade over time
    - Real-time emotion label display
-----------------------------------------*/

const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const typingIndicator = document.getElementById('typingIndicator');
const exportBtn = document.getElementById('exportBtn');

const graphCanvas = document.getElementById('graphCanvas');
const ctx = graphCanvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

const sessionsListEl = document.getElementById('sessionsList');
const newSessionBtn = document.getElementById('newSessionBtn');
const saveSessionBtn = document.getElementById('saveSessionBtn');
const clearGraphBtn = document.getElementById('clearGraphBtn');
const downloadGraphBtn = document.getElementById('downloadGraphBtn');
const saveNodesBtn = document.getElementById('saveNodesBtn');

// emotion label
const emotionLabel = document.createElement("div");
emotionLabel.style.textAlign = "center";
emotionLabel.style.fontWeight = "600";
emotionLabel.style.fontSize = "0.95rem";
emotionLabel.style.marginTop = "6px";
emotionLabel.style.opacity = "0.8";
document.querySelector(".side-graph").appendChild(emotionLabel);

const STORAGE = {
  nodes: 'mindchat_nodes_v5',
  links: 'mindchat_links_v5',
  sessions: 'mindchat_sessions_v5',
  activeSessionId: 'mindchat_active_session_v5',
  messages: 'mindchat_messages_v5'
};

// memory
let nodes = JSON.parse(localStorage.getItem(STORAGE.nodes) || '[]');
let links = JSON.parse(localStorage.getItem(STORAGE.links) || '[]');
let sessions = JSON.parse(localStorage.getItem(STORAGE.sessions) || '[]');
let messages = JSON.parse(localStorage.getItem(STORAGE.messages) || '[]');
let activeSession = localStorage.getItem(STORAGE.activeSessionId) || null;

/* ---------- helper ---------- */
function uid(p='id'){ return p+'_'+Math.random().toString(36).slice(2,9); }
function saveNodes(){ localStorage.setItem(STORAGE.nodes, JSON.stringify(nodes)); }
function saveLinks(){ localStorage.setItem(STORAGE.links, JSON.stringify(links)); }
function saveMessages(){ localStorage.setItem(STORAGE.messages, JSON.stringify(messages)); }

/* ---------- sentiment ---------- */
function analyzeEmotion(text){
  const low = text.toLowerCase();
  if(/love|happy|excited|joy|great/.test(low)) return {label:"Happy", color:"#ffd166"};
  if(/sad|upset|tired|cry|lonely/.test(low)) return {label:"Sad", color:"#118ab2"};
  if(/angry|mad|hate|furious/.test(low)) return {label:"Angry", color:"#ef476f"};
  if(/calm|ok|fine|peace|normal/.test(low)) return {label:"Calm", color:"#06d6a0"};
  return {label:"Reflective", color:"#8338ec"};
}

/* ---------- chat send ---------- */
async function sendMessage(){
  const text = userInput.value.trim();
  if(!text) return;
  const ts = Date.now();
  messages.push({who:'user', text, ts});
  saveMessages();
  appendMessage(text,'user',ts);
  addNodeToGraph(text,'user',ts);
  userInput.value='';
  setTyping(true);
  const delay = 600+Math.floor(Math.random()*600);
  setTimeout(()=>{
    const reply = generateAIReply(text);
    const ts2 = Date.now();
    messages.push({who:'ai', text:reply, ts:ts2});
    saveMessages();
    appendMessage(reply,'ai',ts2);
    addNodeToGraph(reply,'ai',ts2);
    setTyping(false);
  }, delay);
}

/* ---------- UI message append ---------- */
function appendMessage(text, who, ts){
  const el=document.createElement('div');
  el.className='message '+(who==='user'?'user':'ai');
  el.innerHTML=`<div>${escapeHtml(text)}</div>
                <div class="meta">${who==='user'?'You':'MindChat AI'} â€¢ ${new Date(ts).toLocaleTimeString()}</div>`;
  chatWindow.appendChild(el);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}
function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* ---------- graph nodes ---------- */
function addNodeToGraph(text,type,ts){
  const emotion = analyzeEmotion(text);
  const x = 30 + Math.random()*(graphCanvas.width-60);
  const y = 30 + Math.random()*(graphCanvas.height-60);
  const node = {
    id: uid('n'),
    text, ts, x, y,
    color: emotion.color,
    emotion: emotion.label,
    glow: 1,
    fade: 1.0,
    dx:(Math.random()-.5)*1.2,
    dy:(Math.random()-.5)*1.2
  };
  const last = nodes[nodes.length-1];
  if(last) links.push({a:last.id,b:node.id, pulse:1});
  nodes.push(node);
  emotionLabel.textContent = "Mood: " + emotion.label;
  saveNodes(); saveLinks();
}

/* ---------- draw graph ---------- */
function drawGraph(){
  ctx.clearRect(0,0,graphCanvas.width,graphCanvas.height);

  // update link pulse
  links.forEach(l=>{
    l.pulse = (l.pulse||0)*0.95;
    const a = nodes.find(n=>n.id===l.a);
    const b = nodes.find(n=>n.id===l.b);
    if(!a||!b) return;
    const grad = ctx.createLinearGradient(a.x,a.y,b.x,b.y);
    grad.addColorStop(0,'rgba(123,92,255,'+(0.2+l.pulse*0.6)+')');
    grad.addColorStop(1,'rgba(123,92,255,0.1)');
    ctx.strokeStyle=grad;
    ctx.lineWidth=1.4;
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(b.x,b.y);
    ctx.stroke();
  });

  nodes.forEach(n=>{
    // movement
    n.x+=n.dx; n.y+=n.dy;
    if(n.x<12||n.x>graphCanvas.width-12) n.dx*=-1;
    if(n.y<12||n.y>graphCanvas.height-12) n.dy*=-1;
    // fade older
    const age = (Date.now()-n.ts)/60000;
    n.fade = Math.max(0.2, 1 - age*0.02);
    const glow = n.glow*0.8;
    ctx.beginPath();
    ctx.fillStyle=n.color;
    ctx.globalAlpha = n.fade;
    ctx.shadowColor=n.color;
    ctx.shadowBlur=12*glow;
    ctx.arc(n.x,n.y,7,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.globalAlpha=1;
    n.glow*=0.95;
  });
  requestAnimationFrame(drawGraph);
}

/* ---------- start ---------- */
renderMessages();
drawGraph();
sendBtn.onclick=sendMessage;
userInput.addEventListener('keydown',(e)=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){sendMessage();}});

function generateAIReply(t){
  const arr=[
    "That's an interesting thought ðŸŒ±",
    "Hmm, your feeling connects with a past memory ðŸ’«",
    "I sense calm reflection here ðŸ•Š",
    "Let's store this safely in memory ðŸ§ "
  ];
  return arr[Math.floor(Math.random()*arr.length)];
}
function setTyping(on){typingIndicator.textContent=on?'MindChat is thinkingâ€¦':'';}
function renderMessages(){
  chatWindow.innerHTML='';
  if(!messages.length){
    const greet='Hello ðŸ‘‹ Iâ€™m MindChat AI, your evolving memory companion.';
    messages=[{who:'ai',text:greet,ts:Date.now()}];
    saveMessages();
  }
  messages.forEach(m=>appendMessage(m.text,m.who,m.ts));
}
</script>
</body>
</html>
